2022-08-16 13:09:02.630 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:09:02.645 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 2564 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:09:02.646 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:09:02.646 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:09:03.365 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 13:09:03.371 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 13:09:03.371 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 13:09:03.371 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 13:09:03.456 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 13:09:03.456 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 781 ms
2022-08-16 13:09:03.838 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:09:04.173 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 13:09:04.186 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 13:09:04.226 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.93 seconds (JVM running for 2.511)
2022-08-16 13:11:15.983 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:11:15.988 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 11924 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:11:15.988 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:11:15.988 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:11:16.781 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 13:11:16.787 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 13:11:16.788 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 13:11:16.788 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 13:11:16.871 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 13:11:16.871 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 861 ms
2022-08-16 13:11:17.247 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:11:17.557 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 13:11:17.570 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 13:11:17.613 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.939 seconds (JVM running for 2.439)
2022-08-16 13:12:04.589 INFO [http-nio-8180-exec-1]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 13:12:04.590 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 13:12:04.594 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 4 ms
2022-08-16 13:14:21.103 INFO [http-nio-8180-exec-6]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> apiVersion: v1
kind: Namespace 
metadata:
  name: "testmy" # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: "testmy" # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: "testmy" # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/"testmy""  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: "testmy" # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: "testmy" # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: "testmy" # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: "testmy" # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: "testmy" # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: "testmy"
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: "testmy"
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: "testmy"
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: "testmy"
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: "testmy"
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:14:21.118 INFO [http-nio-8180-exec-6]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:448 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/15.0.1/client-java-api-15.0.1.jar
2022-08-16 13:15:38.858 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:15:38.949 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 testmy
2022-08-16 13:15:43.078 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:15:43.078 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-config
2022-08-16 13:15:47.174 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:15:47.174 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 media-volume-01
2022-08-16 13:15:51.271 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:15:51.272 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 media-volume-claim
2022-08-16 13:15:55.347 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:15:55.347 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 13:15:59.448 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:15:59.448 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-coreapp-service
2022-08-16 13:16:03.545 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:03.545 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 13:16:07.649 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:07.649 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-master-autoscaler
2022-08-16 13:16:11.756 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:11.757 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-master-service
2022-08-16 13:16:15.856 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:15.856 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-master-deployment
2022-08-16 13:16:19.953 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:19.953 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-web-autoscaler
2022-08-16 13:16:24.051 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:24.051 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-web-service
2022-08-16 13:16:28.138 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:16:28.138 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:253 ----- delete request resource---: 
 whatsapp-web-deployment
2022-08-16 13:16:32.233 INFO [http-nio-8180-exec-9]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:296 ----- delete response---: 
 null
2022-08-16 13:21:59.995 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:22:17.509 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.removeConfigFile:198 -delete config directory:C:\Users\dell\Documents\Downloads\whats-test\config-testmy
2022-08-16 13:22:29.374 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 testmy
2022-08-16 13:22:33.489 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:22:47.202 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-config
2022-08-16 13:22:51.308 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:22:51.308 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 media-volume-01
2022-08-16 13:22:55.402 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:22:55.402 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 media-volume-claim
2022-08-16 13:22:59.496 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:22:59.496 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 13:23:03.577 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:03.577 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-coreapp-service
2022-08-16 13:23:07.669 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:07.669 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 13:23:11.752 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:11.752 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-master-autoscaler
2022-08-16 13:23:15.866 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:15.866 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-master-service
2022-08-16 13:23:19.950 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:19.950 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-master-deployment
2022-08-16 13:23:24.049 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:24.049 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-web-autoscaler
2022-08-16 13:23:28.135 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:28.135 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-web-service
2022-08-16 13:23:32.241 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:32.241 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-web-deployment
2022-08-16 13:23:36.336 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:23:49.289 INFO [http-nio-8180-exec-3]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:23:53.698 INFO [http-nio-8180-exec-3]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.removeConfigFile:198 -delete config directory:C:\Users\dell\Documents\Downloads\whats-test\config-testmy
2022-08-16 13:24:54.275 INFO [http-nio-8180-exec-4]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:24:54.277 INFO [http-nio-8180-exec-4]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.removeConfigFile:198 -delete config directory:C:\Users\dell\Documents\Downloads\whats-test\config-testmy
2022-08-16 13:26:09.184 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 28464 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:26:09.186 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:26:09.186 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:26:09.249 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:26:10.326 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:26:11.113 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.18 seconds (JVM running for 2.759)
2022-08-16 13:31:25.367 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 9320 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:31:25.369 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:31:25.369 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:31:25.370 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:31:26.128 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 13:31:26.134 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 13:31:26.135 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 13:31:26.135 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 13:31:26.215 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 13:31:26.216 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 815 ms
2022-08-16 13:31:26.572 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:31:26.896 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 13:31:26.910 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 13:31:26.956 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.09 seconds (JVM running for 3.393)
2022-08-16 13:31:36.615 INFO [http-nio-8180-exec-1]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 13:31:36.615 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 13:31:36.620 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 5 ms
2022-08-16 13:31:36.691 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:31:36.692 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.removeConfigFile:198 -delete config directory:C:\Users\dell\Documents\Downloads\whats-test\config-testmy
2022-08-16 13:31:55.177 INFO [http-nio-8180-exec-1]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:448 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/15.0.1/client-java-api-15.0.1.jar
2022-08-16 13:31:55.449 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 testmy
2022-08-16 13:31:59.572 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:31:59.573 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-config
2022-08-16 13:32:03.657 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:03.657 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 media-volume-01
2022-08-16 13:32:07.744 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:07.745 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 media-volume-claim
2022-08-16 13:32:11.838 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:11.839 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 13:32:15.913 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:15.913 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-coreapp-service
2022-08-16 13:32:20.007 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:20.007 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 13:32:24.120 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:24.120 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-master-autoscaler
2022-08-16 13:32:28.202 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:28.202 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-master-service
2022-08-16 13:32:32.284 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:32.284 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-master-deployment
2022-08-16 13:32:36.367 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:36.367 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-web-autoscaler
2022-08-16 13:32:40.448 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:40.448 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-web-service
2022-08-16 13:32:44.537 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:32:44.538 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:256 ----- delete request resource---: 
 whatsapp-web-deployment
2022-08-16 13:32:48.625 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:299 ----- delete response---: 
 null
2022-08-16 13:36:00.244 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:36:00.255 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 26036 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:36:00.255 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:36:00.259 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:36:01.019 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 13:36:01.024 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 13:36:01.025 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 13:36:01.025 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 13:36:01.185 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 13:36:01.185 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 885 ms
2022-08-16 13:36:01.671 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:36:02.053 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 13:36:02.068 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 13:36:02.116 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.348 seconds (JVM running for 3.179)
2022-08-16 13:36:59.284 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 13:36:59.285 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 13:36:59.289 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 4 ms
2022-08-16 13:37:38.414 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 17008 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:37:38.416 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:37:38.416 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:37:38.417 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:37:39.186 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 13:37:39.191 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 13:37:39.192 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 13:37:39.192 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 13:37:39.265 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 13:37:39.266 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 814 ms
2022-08-16 13:37:39.616 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:37:39.915 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 13:37:39.927 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 13:37:39.970 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.337 seconds (JVM running for 3.282)
2022-08-16 13:37:45.851 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 13:37:45.852 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 13:37:45.856 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 4 ms
2022-08-16 13:37:45.921 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 13:37:45.921 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.removeConfigFile:198 -delete config directory:C:\Users\dell\Documents\Downloads\whats-test\config-testmy
2022-08-16 13:37:45.933 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:448 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/15.0.1/client-java-api-15.0.1.jar
2022-08-16 13:37:46.208 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 testmy
2022-08-16 13:37:50.290 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:37:50.291 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-config
2022-08-16 13:37:54.367 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:37:54.367 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 media-volume-01
2022-08-16 13:37:58.466 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:37:58.467 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 media-volume-claim
2022-08-16 13:38:02.566 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:02.567 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 13:38:06.682 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:06.682 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-coreapp-service
2022-08-16 13:38:10.797 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:10.798 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 13:38:14.883 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:14.883 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-master-autoscaler
2022-08-16 13:38:18.976 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:18.976 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-master-service
2022-08-16 13:38:23.062 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:23.062 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-master-deployment
2022-08-16 13:38:27.142 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:27.142 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-web-autoscaler
2022-08-16 13:38:31.231 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:31.231 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-web-service
2022-08-16 13:38:35.329 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:38:35.329 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:266 ----- delete request resource---: 
 whatsapp-web-deployment
2022-08-16 13:38:39.430 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:309 ----- delete response---: 
 null
2022-08-16 13:41:16.749 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 32140 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 13:41:16.750 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 13:41:16.750 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 13:41:16.810 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 13:41:17.889 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 13:41:18.667 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.164 seconds (JVM running for 2.733)
2022-08-16 14:43:15.658 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 14:43:15.672 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 27912 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 14:43:15.672 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 14:43:15.673 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 14:43:16.388 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 14:43:16.394 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:16.395 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 14:43:16.395 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 14:43:16.468 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 14:43:16.469 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 771 ms
2022-08-16 14:43:16.849 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 14:43:17.170 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:17.176 WARN [main]o.s.b.w.s.c.AnnotationConfigServletWebServerApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.context.ApplicationContextException: Failed to start bean 'webServerStartStop'; nested exception is org.springframework.boot.web.server.PortInUseException: Port 8180 is already in use
2022-08-16 14:43:17.179 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Pausing ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:17.179 INFO [main]org.apache.catalina.core.StandardService.log:173 -Stopping service [Tomcat]
2022-08-16 14:43:17.183 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Stopping ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:17.183 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Destroying ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:17.187 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 14:43:27.842 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 13532 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 14:43:27.842 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 14:43:27.844 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 14:43:27.844 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 14:43:28.556 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 14:43:28.562 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:28.563 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 14:43:28.563 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 14:43:28.639 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 14:43:28.639 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 772 ms
2022-08-16 14:43:28.987 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 14:43:29.286 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 14:43:29.298 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 14:43:29.339 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.831 seconds (JVM running for 2.397)
2022-08-16 14:43:37.586 INFO [http-nio-8180-exec-1]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 14:43:37.586 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 14:43:37.590 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 4 ms
2022-08-16 14:43:37.652 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 14:43:37.652 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.removeConfigFile:198 -delete config directory:C:\Users\dell\Documents\Downloads\whats-test\config-testmy
2022-08-16 14:43:37.662 INFO [http-nio-8180-exec-1]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:448 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/16.0.0/client-java-api-16.0.0.jar
2022-08-16 14:43:37.926 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 testmy
2022-08-16 14:43:42.067 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:43:42.067 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 whatsapp-config
2022-08-16 14:43:46.153 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:43:46.153 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 media-volume-01
2022-08-16 14:43:50.255 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:43:50.255 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 media-volume-claim
2022-08-16 14:43:54.372 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:43:54.372 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 14:43:58.480 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:43:58.480 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 whatsapp-coreapp-service
2022-08-16 14:44:02.597 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:44:02.597 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 14:44:06.691 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:44:06.691 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 whatsapp-master-autoscaler
2022-08-16 14:44:10.803 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:310 ----- delete response---: 
 null
2022-08-16 14:44:10.804 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.deleteSource:267 ----- delete request resource---: 
 whatsapp-master-service
2022-08-16 14:44:26.074 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 32460 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 14:44:26.075 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 14:44:26.075 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 14:44:26.132 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 14:44:27.214 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 14:44:27.962 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.133 seconds (JVM running for 2.718)
2022-08-16 14:50:13.077 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 26868 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 14:50:13.078 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 14:50:13.078 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 14:50:13.136 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 14:50:14.208 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 14:50:14.977 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.145 seconds (JVM running for 2.711)
2022-08-16 14:50:30.873 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 14:50:30.885 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 25748 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 14:50:30.885 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 14:50:30.885 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 14:50:31.566 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 14:50:31.571 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 14:50:31.572 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 14:50:31.572 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 14:50:31.646 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 14:50:31.646 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 739 ms
2022-08-16 14:50:32.004 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 14:50:32.315 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 14:50:32.328 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 14:50:32.371 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.831 seconds (JVM running for 2.448)
2022-08-16 14:50:41.615 INFO [http-nio-8180-exec-1]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 14:50:41.615 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 14:50:41.619 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 4 ms
2022-08-16 14:50:41.681 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:138 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 14:51:06.251 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 20872 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 14:51:06.252 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 14:51:06.253 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 14:51:06.304 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 14:51:07.364 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:36 ----k8s connected----
 http://localhost:8080
2022-08-16 14:51:08.129 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.118 seconds (JVM running for 2.689)
2022-08-16 15:34:33.226 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 20872 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 15:34:33.227 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 15:34:33.227 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 15:34:33.281 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 15:34:33.979 WARN [main]o.s.web.context.support.GenericWebApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'k8sClientController': Unsatisfied dependency expressed through field 'autoDeployService'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'autoDeployServiceImpl': Unsatisfied dependency expressed through field 'apiInstance'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'coreV1Api' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Unsatisfied dependency expressed through method 'coreV1Api' parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'apiClient' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [io.kubernetes.client.openapi.ApiClient]: Factory method 'apiClient' threw exception; nested exception is java.io.FileNotFoundException: ~\.kube\config (ϵͳҲָ·)
2022-08-16 15:34:33.984 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 15:36:30.181 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 32560 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 15:36:30.182 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 15:36:30.183 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 15:36:30.236 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 15:36:31.328 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:46 ----k8s connected----
 ~/.kube/config
2022-08-16 15:36:31.330 WARN [main]o.s.web.context.support.GenericWebApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'k8sClientController': Unsatisfied dependency expressed through field 'autoDeployService'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'autoDeployServiceImpl': Unsatisfied dependency expressed through field 'apiInstance'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'coreV1Api' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Unsatisfied dependency expressed through method 'coreV1Api' parameter 0; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'io.kubernetes.client.openapi.ApiClient' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}
2022-08-16 15:36:31.335 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 15:38:37.666 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 23384 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 15:38:37.667 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 15:38:37.667 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 15:38:37.725 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 15:38:38.817 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:46 ----k8s connected----
 ~\.kube\config
2022-08-16 15:38:38.819 WARN [main]o.s.web.context.support.GenericWebApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'k8sClientController': Unsatisfied dependency expressed through field 'autoDeployService'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'autoDeployServiceImpl': Unsatisfied dependency expressed through field 'apiInstance'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'coreV1Api' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Unsatisfied dependency expressed through method 'coreV1Api' parameter 0; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'io.kubernetes.client.openapi.ApiClient' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}
2022-08-16 15:38:38.826 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 15:39:44.831 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 20664 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 15:39:44.832 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 15:39:44.832 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 15:39:44.888 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 15:39:45.574 WARN [main]o.s.web.context.support.GenericWebApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'k8sClientController': Unsatisfied dependency expressed through field 'autoDeployService'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'autoDeployServiceImpl': Unsatisfied dependency expressed through field 'apiInstance'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'coreV1Api' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Unsatisfied dependency expressed through method 'coreV1Api' parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'apiClient' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [io.kubernetes.client.openapi.ApiClient]: Factory method 'apiClient' threw exception; nested exception is java.lang.NullPointerException
2022-08-16 15:39:45.580 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 15:41:19.581 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 29024 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 15:41:19.582 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 15:41:19.582 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 15:41:19.635 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 15:41:20.339 WARN [main]o.s.web.context.support.GenericWebApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'k8sClientController': Unsatisfied dependency expressed through field 'autoDeployService'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'autoDeployServiceImpl': Unsatisfied dependency expressed through field 'apiInstance'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'coreV1Api' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Unsatisfied dependency expressed through method 'coreV1Api' parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'apiClient' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [io.kubernetes.client.openapi.ApiClient]: Factory method 'apiClient' threw exception; nested exception is java.lang.NullPointerException
2022-08-16 15:41:20.344 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 16:48:43.014 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 33240 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 16:48:43.017 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 16:48:43.017 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 16:48:43.020 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 16:48:44.356 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 16:48:44.366 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 16:48:44.367 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 16:48:44.367 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 16:48:44.498 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 16:48:44.500 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1458 ms
2022-08-16 16:48:44.587 WARN [main]o.s.b.w.s.c.AnnotationConfigServletWebServerApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'k8sClientController': Unsatisfied dependency expressed through field 'autoDeployService'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'autoDeployServiceImpl': Unsatisfied dependency expressed through field 'apiInstance'; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'coreV1Api' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Unsatisfied dependency expressed through method 'coreV1Api' parameter 0; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'apiClient' defined in class path resource [com/nxtele/k8s/client/configuration/K8sClientConfig.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [io.kubernetes.client.openapi.ApiClient]: Factory method 'apiClient' threw exception; nested exception is java.lang.NullPointerException
2022-08-16 16:48:44.590 INFO [main]org.apache.catalina.core.StandardService.log:173 -Stopping service [Tomcat]
2022-08-16 16:48:44.606 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 16:50:23.906 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 16:50:23.911 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 33208 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 16:50:23.911 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 16:50:23.911 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 16:50:24.577 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 16:50:24.582 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 16:50:24.583 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 16:50:24.583 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 16:50:24.657 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 16:50:24.657 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 723 ms
2022-08-16 16:50:25.029 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:48 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 16:50:25.348 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 16:50:25.361 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 16:50:25.403 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.82 seconds (JVM running for 2.349)
2022-08-16 16:54:31.944 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 7764 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 16:54:31.945 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 16:54:31.946 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 16:54:31.999 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 16:54:33.118 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:48 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 16:54:33.909 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.268 seconds (JVM running for 2.888)
2022-08-16 17:01:40.754 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 21744 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 17:01:40.756 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 17:01:40.756 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 17:01:40.807 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 17:01:41.897 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 17:01:42.652 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.146 seconds (JVM running for 2.737)
2022-08-16 17:05:00.423 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 13240 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 17:05:00.424 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 17:05:00.425 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 17:05:00.425 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 17:05:01.125 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 17:05:01.131 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 17:05:01.131 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 17:05:01.131 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 17:05:01.204 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 17:05:01.204 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 755 ms
2022-08-16 17:05:01.565 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 17:05:01.875 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 17:05:01.888 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 17:05:01.929 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.833 seconds (JVM running for 2.419)
2022-08-16 17:41:09.085 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 17:41:09.126 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 5984 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 17:41:09.127 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 17:41:09.127 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 17:41:09.752 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 17:41:09.757 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 17:41:09.758 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 17:41:09.758 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 17:41:09.827 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 17:41:09.827 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 677 ms
2022-08-16 17:41:10.142 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 17:41:10.417 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 17:41:10.427 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 17:41:10.462 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.646 seconds (JVM running for 2.101)
2022-08-16 17:54:50.943 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication v0.0.1-SNAPSHOT on xuxunjian with PID 2616 (C:\Users\dell\IdeaProjects\k8sclient\target\client-0.0.1-SNAPSHOT.jar started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 17:54:50.945 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 17:54:50.946 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 17:54:50.961 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 17:54:52.414 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 17:54:52.427 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 17:54:52.427 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 17:54:52.427 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 17:54:52.488 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 17:54:52.489 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1499 ms
2022-08-16 17:54:52.785 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 17:54:53.271 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 17:54:53.311 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 17:54:53.501 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 3.122 seconds (JVM running for 3.492)
2022-08-16 17:55:01.858 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 17:55:01.858 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 17:55:01.864 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 5 ms
2022-08-16 17:55:01.944 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:140 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔?
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 17:55:01.947 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:180 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 17:55:01.956 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/IdeaProjects/k8sclient/target/client-0.0.1-SNAPSHOT.jar
2022-08-16 17:57:06.765 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 17:57:06.772 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 18200 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 17:57:06.772 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 17:57:06.773 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 17:57:07.477 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 17:57:07.483 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 17:57:07.483 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 17:57:07.484 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 17:57:07.563 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 17:57:07.564 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 764 ms
2022-08-16 17:57:07.932 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 17:57:08.245 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 17:57:08.258 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 17:57:08.300 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.919 seconds (JVM running for 2.473)
2022-08-16 17:57:26.739 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 17:57:26.740 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 17:57:26.743 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 3 ms
2022-08-16 17:57:31.513 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:140 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 17:57:31.513 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:180 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 17:58:36.054 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/13.0.0/client-java-api-13.0.0.jar
2022-08-16 17:59:13.512 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 testmy
2022-08-16 17:59:17.648 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:17.648 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-config
2022-08-16 17:59:21.718 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:21.718 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 media-volume-01
2022-08-16 17:59:25.824 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:25.824 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 media-volume-claim
2022-08-16 17:59:29.926 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:29.926 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 17:59:34.020 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:34.020 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-coreapp-service
2022-08-16 17:59:38.123 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:38.123 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 17:59:42.215 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:42.216 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-master-autoscaler
2022-08-16 17:59:46.285 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:46.285 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-master-service
2022-08-16 17:59:50.377 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:50.377 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-master-deployment
2022-08-16 17:59:54.475 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:54.475 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-web-autoscaler
2022-08-16 17:59:58.577 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 17:59:58.577 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-web-service
2022-08-16 18:00:02.671 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 18:00:02.671 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:221 ----- create request resource---: 
 whatsapp-web-deployment
2022-08-16 18:00:06.759 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:262 -----create response---: 
 null
2022-08-16 19:39:47.682 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication v0.0.1-SNAPSHOT on xuxunjian with PID 14248 (C:\Users\dell\IdeaProjects\k8sclient\target\client-0.0.1-SNAPSHOT.jar started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:39:47.685 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:39:47.687 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:39:47.694 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:39:49.044 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:39:49.055 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:39:49.056 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:39:49.057 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:39:49.113 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:39:49.114 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1388 ms
2022-08-16 19:39:49.366 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:39:49.846 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:39:49.878 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:39:50.052 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.897 seconds (JVM running for 3.254)
2022-08-16 19:40:04.530 INFO [http-nio-8180-exec-4]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:40:04.531 INFO [http-nio-8180-exec-4]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:40:04.538 INFO [http-nio-8180-exec-4]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 7 ms
2022-08-16 19:40:04.616 INFO [http-nio-8180-exec-4]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:140 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔?
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:40:04.619 INFO [http-nio-8180-exec-4]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:180 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:40:04.628 INFO [http-nio-8180-exec-4]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/IdeaProjects/k8sclient/target/client-0.0.1-SNAPSHOT.jar
2022-08-16 19:43:59.893 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 31544 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:43:59.893 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:43:59.895 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:43:59.895 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:44:00.521 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:44:00.526 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:44:00.527 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:44:00.527 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:44:00.609 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:44:00.609 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 692 ms
2022-08-16 19:44:00.912 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:44:01.179 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:44:01.189 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:44:01.223 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.618 seconds (JVM running for 2.047)
2022-08-16 19:44:42.551 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:44:42.552 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:44:42.555 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 3 ms
2022-08-16 19:44:42.610 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:141 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:44:42.611 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:181 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:44:42.615 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/13.0.0/client-java-api-13.0.0.jar
2022-08-16 19:44:42.845 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 testmy
2022-08-16 19:44:46.976 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:44:46.976 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-config
2022-08-16 19:44:51.066 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:44:51.067 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 media-volume-01
2022-08-16 19:44:55.173 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:44:55.174 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 media-volume-claim
2022-08-16 19:44:59.265 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:44:59.265 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 19:45:03.374 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:03.374 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-coreapp-service
2022-08-16 19:45:07.450 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:07.450 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 19:45:11.531 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:11.531 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-master-autoscaler
2022-08-16 19:45:15.618 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:15.618 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-master-service
2022-08-16 19:45:19.708 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:19.708 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-master-deployment
2022-08-16 19:45:23.830 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:23.830 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-web-autoscaler
2022-08-16 19:45:27.915 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:27.915 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-web-service
2022-08-16 19:45:32.016 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:32.016 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-web-deployment
2022-08-16 19:45:36.109 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:45:55.022 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication v0.0.1-SNAPSHOT on xuxunjian with PID 22804 (C:\Users\dell\IdeaProjects\k8sclient\target\client-0.0.1-SNAPSHOT.jar started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:45:55.025 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:45:55.025 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:45:55.029 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:45:56.376 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:45:56.385 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:45:56.385 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:45:56.386 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:45:56.440 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:45:56.440 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1369 ms
2022-08-16 19:45:56.692 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:45:57.175 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:45:57.216 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:45:57.401 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.945 seconds (JVM running for 3.3)
2022-08-16 19:46:19.691 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:46:19.691 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:46:19.697 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 5 ms
2022-08-16 19:46:19.777 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:140 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔?
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:46:19.779 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:180 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:46:19.789 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/IdeaProjects/k8sclient/target/client-0.0.1-SNAPSHOT.jar
2022-08-16 19:48:12.278 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication v0.0.1-SNAPSHOT on xuxunjian with PID 19416 (C:\Users\dell\IdeaProjects\k8sclient\target\client-0.0.1-SNAPSHOT.jar started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:48:12.281 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:48:12.281 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:48:12.299 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:48:13.615 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:48:13.626 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:48:13.627 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:48:13.627 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:48:13.688 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:48:13.688 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1367 ms
2022-08-16 19:48:13.939 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:48:14.403 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:48:14.437 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:48:14.613 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.844 seconds (JVM running for 3.209)
2022-08-16 19:48:21.569 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:48:21.569 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:48:21.575 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 5 ms
2022-08-16 19:48:21.664 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:140 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔?
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:48:21.667 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:180 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:48:21.674 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/IdeaProjects/k8sclient/target/client-0.0.1-SNAPSHOT.jar
2022-08-16 19:49:59.818 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:49:59.827 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 19536 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:49:59.827 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:49:59.827 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:50:00.526 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:50:00.533 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:50:00.534 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:50:00.534 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:50:00.614 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:50:00.614 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 765 ms
2022-08-16 19:50:00.972 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:50:01.310 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:50:01.325 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:50:01.375 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.9 seconds (JVM running for 2.402)
2022-08-16 19:50:06.625 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:50:06.625 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:50:06.629 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 3 ms
2022-08-16 19:50:06.708 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:141 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:50:06.709 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:181 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:50:06.713 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/13.0.0/client-java-api-13.0.0.jar
2022-08-16 19:50:06.999 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 testmy
2022-08-16 19:50:11.127 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:11.128 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-config
2022-08-16 19:50:15.190 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:15.191 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 media-volume-01
2022-08-16 19:50:19.297 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:19.297 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 media-volume-claim
2022-08-16 19:50:23.373 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:23.373 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-coreapp-autoscaler
2022-08-16 19:50:27.467 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:27.468 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-coreapp-service
2022-08-16 19:50:31.560 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:31.560 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-coreapp-deployment
2022-08-16 19:50:35.654 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:35.655 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-master-autoscaler
2022-08-16 19:50:39.749 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:39.749 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-master-service
2022-08-16 19:50:43.885 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:263 -----create response---: 
 null
2022-08-16 19:50:43.886 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:222 ----- create request resource---: 
 whatsapp-master-deployment
2022-08-16 19:50:56.093 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication v0.0.1-SNAPSHOT on xuxunjian with PID 9000 (C:\Users\dell\IdeaProjects\k8sclient\target\client-0.0.1-SNAPSHOT.jar started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:50:56.095 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:50:56.096 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:50:56.107 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:50:57.443 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:50:57.452 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:50:57.453 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:50:57.453 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:50:57.508 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:50:57.508 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1371 ms
2022-08-16 19:50:57.757 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:50:58.232 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:50:58.265 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:50:58.445 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 2.932 seconds (JVM running for 3.301)
2022-08-16 19:51:09.477 INFO [http-nio-8180-exec-1]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:51:09.477 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:51:09.483 INFO [http-nio-8180-exec-1]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 5 ms
2022-08-16 19:51:09.560 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:140 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔?
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:51:09.563 INFO [http-nio-8180-exec-1]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:180 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:51:09.570 INFO [http-nio-8180-exec-1]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/IdeaProjects/k8sclient/target/client-0.0.1-SNAPSHOT.jar
2022-08-16 19:54:24.756 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:54:24.761 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 26320 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:54:24.761 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:54:24.761 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:54:25.441 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:54:25.447 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:25.448 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:54:25.448 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:54:25.526 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:54:25.526 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 743 ms
2022-08-16 19:54:25.886 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:54:26.197 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:26.203 WARN [main]o.s.b.w.s.c.AnnotationConfigServletWebServerApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.context.ApplicationContextException: Failed to start bean 'webServerStartStop'; nested exception is org.springframework.boot.web.server.PortInUseException: Port 8180 is already in use
2022-08-16 19:54:26.206 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Pausing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:26.207 INFO [main]org.apache.catalina.core.StandardService.log:173 -Stopping service [Tomcat]
2022-08-16 19:54:26.210 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Stopping ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:26.210 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Destroying ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:26.213 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 19:54:35.888 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:54:35.895 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 7100 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:54:35.895 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:54:35.895 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:54:36.583 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:54:36.588 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:36.588 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:54:36.588 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:54:36.670 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:54:36.670 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 752 ms
2022-08-16 19:54:37.023 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:54:37.321 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:54:37.333 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:54:37.373 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.798 seconds (JVM running for 2.366)
2022-08-16 19:54:46.625 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:54:46.626 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:54:46.630 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 4 ms
2022-08-16 19:54:46.692 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:147 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔离
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:54:46.694 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/.m2/repository/io/kubernetes/client-java-api/13.0.0/client-java-api-13.0.0.jar
2022-08-16 19:54:46.841 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:187 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 19:54:46.967 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:228 ----- create request resource---: 
 testmy
2022-08-16 19:54:51.091 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:269 -----create response---: 
 null
2022-08-16 19:54:51.092 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:228 ----- create request resource---: 
 whatsapp-config
2022-08-16 19:54:55.185 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:269 -----create response---: 
 null
2022-08-16 19:54:55.185 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:228 ----- create request resource---: 
 media-volume-01
2022-08-16 19:54:59.267 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:269 -----create response---: 
 null
2022-08-16 19:54:59.267 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.createSource:228 ----- create request resource---: 
 media-volume-claim
2022-08-16 19:55:22.259 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:55 -Starting ClientApplicationTests on xuxunjian with PID 28084 (started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:55:22.260 DEBUG[main]com.nxtele.k8s.client.ClientApplicationTests.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:55:22.260 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:55:22.320 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:55:23.406 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:55:24.173 INFO [main]com.nxtele.k8s.client.ClientApplicationTests.logStarted:61 -Started ClientApplicationTests in 2.158 seconds (JVM running for 2.745)
2022-08-16 19:55:32.057 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication v0.0.1-SNAPSHOT on xuxunjian with PID 32056 (C:\Users\dell\IdeaProjects\k8sclient\target\client-0.0.1-SNAPSHOT.jar started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 19:55:32.060 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 19:55:32.060 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 19:55:32.077 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 19:55:33.492 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 19:55:33.502 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 19:55:33.503 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 19:55:33.503 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 19:55:33.560 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 19:55:33.560 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 1454 ms
2022-08-16 19:55:33.821 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 19:55:34.346 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 19:55:34.382 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 19:55:34.584 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 3.128 seconds (JVM running for 3.497)
2022-08-16 19:55:39.915 INFO [http-nio-8180-exec-2]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring DispatcherServlet 'dispatcherServlet'
2022-08-16 19:55:39.916 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:525 -Initializing Servlet 'dispatcherServlet'
2022-08-16 19:55:39.922 INFO [http-nio-8180-exec-2]org.springframework.web.servlet.DispatcherServlet.initServletBean:547 -Completed initialization in 6 ms
2022-08-16 19:55:40.004 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.parseFile:147 -config yaml -> 
apiVersion: v1
kind: Namespace 
metadata:
  name: testmy # todo 
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: whatsapp-config
  namespace: testmy # var namespace string
data:
  wa-db-engine: 'MYSQL'
  wa-db-hostname: '192.168.49.2'  # var,mysql svc. expose ip; minikube ip; k8s svc ip
  wa-db-port: '31518'             # var,mysql svc.
  wa-db-username: 'root'
  wa-db-password: 'testpass'
  wa-db-connection-idle-timeout: '180000'
  wa-db-name-prefix: 'test_01_' # var, prefix only,
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: media-volume-01  # var，PV不隔?
  namespace: testmy # var
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/opt/whatsapp/wamedia/testmy"  # mount dir
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: media-volume-claim  
  namespace: testmy # var
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-coreapp-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-coreapp-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-coreapp-service
  namespace: testmy # var
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-coreapp
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-coreapp-deployment
  namespace: testmy # var
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-coreapp
  template:
    metadata:
      labels:
        name: whatsapp-coreapp
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-coreapp
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_DB_CONNECTION_IDLE_TIMEOUT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-connection-idle-timeout
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-master-autoscaler
  namespace: testmy # var
spec:
  maxReplicas: 3
  minReplicas: 2
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-master-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-master-service
  namespace: testmy
spec:
  clusterIP: None
  ports:
  - port: 6250
    targetPort: 6250
    protocol: TCP
    name: messaging
  - port: 6251
    targetPort: 6251
    protocol: TCP
    name: contacts
  - port: 6252
    targetPort: 6252
    protocol: TCP
    name: control
  - port: 6253
    targetPort: 6253
    protocol: TCP
    name: healthcheck
  selector:
    name: whatsapp-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-master-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-master
  template:
    metadata:
      labels:
        name: whatsapp-master
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-master
        image: docker.whatsapp.biz/coreapp:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: "0.15"
            memory: 128Mi
        ports:
        - containerPort: 6250
          protocol: TCP
          name: messaging
        - containerPort: 6251
          protocol: TCP
          name: contacts
        - containerPort: 6252
          protocol: TCP
          name: control
        - containerPort: 6253
          protocol: TCP
          name: healthcheck
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_TCP_LISTEN_ADDRESS
          value: 'any'
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_CONFIG_ON_DB
          value: '1'
        - name: COREAPP_EXTERNAL_PORTS
          value: '6250,6251,6252,6253'
        - name: WA_MASTER_NODE
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: COREAPP_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim
---
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: whatsapp-web-autoscaler
  namespace: testmy
spec:
  maxReplicas: 3
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: whatsapp-web-deployment
  targetCPUUtilizationPercentage: 60
---
apiVersion: v1
kind: Service
metadata:
  name: whatsapp-web-service
  namespace: testmy
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: web
  selector:
    name: whatsapp-web
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: whatsapp-web-deployment
  namespace: testmy
spec:
  replicas: 2
  selector:
    matchLabels:
      name: whatsapp-web
  template:
    metadata:
      labels:
        name: whatsapp-web
    spec:
      restartPolicy: "Always"
      containers:
      - name: whatsapp-web
        image: docker.whatsapp.biz/web:v2.41.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory : 128Mi
          requests:
            cpu: "0.15"
            memory : 128Mi
        ports:
        - containerPort: 443
          protocol: TCP
          name: web
        env:
        - name: WA_DB_ENGINE
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-engine
        - name: WA_DB_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-name-prefix
        - name: WA_APP_MULTICONNECT
          value: '1'
        - name: WA_DB_HOSTNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-hostname
        - name: WA_DB_PORT
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-port
        - name: WA_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-username
        - name: WA_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: whatsapp-config
              key: wa-db-password
        - name: WA_WEB_SERVERNAME
          value: 'whatsapp-web-service'
        volumeMounts:
        - name: whatsapp-media
          mountPath: /usr/local/wamedia
        securityContext:
          capabilities:
            drop:
              - MKNOD
      volumes:
      - name: whatsapp-media
        persistentVolumeClaim:
          claimName: media-volume-claim




2022-08-16 19:55:40.011 INFO [http-nio-8180-exec-2]io.kubernetes.client.util.ModelMapper.getClassNamesFromPackage:441 -Loading classes from jar /C:/Users/dell/IdeaProjects/k8sclient/target/client-0.0.1-SNAPSHOT.jar
2022-08-16 19:55:40.012 INFO [http-nio-8180-exec-2]com.nxtele.k8s.client.service.impl.AutoDeployServiceImpl.writeConfigFiles:187 -create config file:C:\Users\dell\Documents\Downloads\whats-test\config-testmy\testtestmy.yaml
2022-08-16 20:19:25.497 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 20:19:25.503 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 28424 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 20:19:25.503 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 20:19:25.503 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 20:19:26.231 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 20:19:26.237 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 20:19:26.238 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 20:19:26.238 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 20:19:26.314 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 20:19:26.314 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 786 ms
2022-08-16 20:19:26.679 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 20:19:26.986 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 20:19:26.993 WARN [main]o.s.b.w.s.c.AnnotationConfigServletWebServerApplicationContext.refresh:559 -Exception encountered during context initialization - cancelling refresh attempt: org.springframework.context.ApplicationContextException: Failed to start bean 'webServerStartStop'; nested exception is org.springframework.boot.web.server.PortInUseException: Port 8180 is already in use
2022-08-16 20:19:26.996 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Pausing ProtocolHandler ["http-nio-8180"]
2022-08-16 20:19:26.996 INFO [main]org.apache.catalina.core.StandardService.log:173 -Stopping service [Tomcat]
2022-08-16 20:19:26.999 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Stopping ProtocolHandler ["http-nio-8180"]
2022-08-16 20:19:26.999 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Destroying ProtocolHandler ["http-nio-8180"]
2022-08-16 20:19:27.003 INFO [main]o.s.b.a.logging.ConditionEvaluationReportLoggingListener.logMessage:136 -

Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2022-08-16 20:24:30.122 WARN [background-preinit]o.s.http.converter.json.Jackson2ObjectMapperBuilder.warn:127 -For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
2022-08-16 20:24:30.130 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarting:55 -Starting ClientApplication on xuxunjian with PID 22416 (C:\Users\dell\IdeaProjects\k8sclient\target\classes started by dell in C:\Users\dell\IdeaProjects\k8sclient)
2022-08-16 20:24:30.131 DEBUG[main]com.nxtele.k8s.client.ClientApplication.logStarting:56 -Running with Spring Boot v2.3.1.RELEASE, Spring v5.2.7.RELEASE
2022-08-16 20:24:30.131 INFO [main]com.nxtele.k8s.client.ClientApplication.logStartupProfileInfo:655 -The following profiles are active: dev
2022-08-16 20:24:30.855 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.initialize:108 -Tomcat initialized with port(s): 8180 (http)
2022-08-16 20:24:30.860 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Initializing ProtocolHandler ["http-nio-8180"]
2022-08-16 20:24:30.861 INFO [main]org.apache.catalina.core.StandardService.log:173 -Starting service [Tomcat]
2022-08-16 20:24:30.861 INFO [main]org.apache.catalina.core.StandardEngine.log:173 -Starting Servlet engine: [Apache Tomcat/9.0.36]
2022-08-16 20:24:30.941 INFO [main]o.a.catalina.core.ContainerBase.[Tomcat].[localhost].[/].log:173 -Initializing Spring embedded WebApplicationContext
2022-08-16 20:24:30.941 INFO [main]o.s.b.w.s.context.ServletWebServerApplicationContext.prepareWebApplicationContext:285 -Root WebApplicationContext: initialization completed in 786 ms
2022-08-16 20:24:31.316 INFO [main]com.nxtele.k8s.client.configuration.K8sClientConfig.apiClient:49 ----k8s connected----
 C:\Users\dell\.kube\config
2022-08-16 20:24:31.644 INFO [main]org.apache.coyote.http11.Http11NioProtocol.log:173 -Starting ProtocolHandler ["http-nio-8180"]
2022-08-16 20:24:31.656 INFO [main]o.s.boot.web.embedded.tomcat.TomcatWebServer.start:220 -Tomcat started on port(s): 8180 (http) with context path ''
2022-08-16 20:24:31.699 INFO [main]com.nxtele.k8s.client.ClientApplication.logStarted:61 -Started ClientApplication in 1.914 seconds (JVM running for 2.426)
